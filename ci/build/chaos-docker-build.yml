# Used for creating and storing a docker image of the Chaos Engine
resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest

resources:
- name: git-chaos-engine
  type: git
  source:
    uri: ((gitlab.uri))
    branch: ((gitlab.branch))
    private_key: |
      ((gitlab.private_key))
    ignore_paths:
    - ci/**
    - cloudformation/**
    - .idea/**

- name: slack-alert
  type: slack-notification
  source:
    url: ((slack.webhookuri))

- name: docker-chaos-engine
  type: docker-image
  source:
    repository: ((docker.repository))
    aws_access_key_id: ((aws_poweruser.aws_access_key_id))
    aws_secret_access_key: ((aws_poweruser.aws_secret_access_key))

on_failure: &generic_slack_failure
  do:
  - put: slack-alert
    params:
      attachments: |
        [{
          "color" : "danger",
          "pretext" : ":warning: *Pipeline [$BUILD_PIPELINE_NAME] failed*",
          "author_name" : "Concourse Build Failure Notification",
          "title" : "Click to access the failed build",
          "title_link" : "$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME",
          "text" : "Context ->",
          "fields" : [
            { "title" : "Git Branch",
              "value" : "[((gitlab.branch))]",
              "short" : true
            },
            {
              "title": "Job",
              "value": "[$BUILD_JOB_NAME]",
              "short": true
            }
          ]
        }]

jobs:
- name: chaos-engine-build
  public: true
  plan:
  - get: git-chaos-engine
    trigger: true
    on_failure: *generic_slack_failure
  - put: docker-chaos-engine
    params:
      build: git-chaos-engine
      target_name: ((gitlab.branch))
      tag_file: git-chaos-engine/.git/short_ref
      tag_prefix: ((gitlab.branch))-
    on_failure: *generic_slack_failure
