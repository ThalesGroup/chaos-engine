zap_scan:
  stage: test
  image: owasp/zap2docker-weekly
  services:
    - name: gitlab-docker-registry.gemaltocloud.com/chaos/chaos-engine:$CI_COMMIT_SHA
      alias: chaos-engine
  only:
    refs:
      - develop
      - master
  variables:
    # Do not change, ZAP tool is expecting this directory. If not present file options are skipped.
    ZAP_WORK_DIR: "/zap/wrk/"
    ZAP_REPORT_FILE: "zap_report.html"
    # Containers in the runner pod are unable to resolve hostnames of neighbour containers, the Engine instance must be referenced thru localhost
    CHAOS_ENGINE_API_URL: "http://localhost:8080/v2/api-docs"
    # With current GL setup it ussualy takes 13 minutes until the Engine API is rechable
    CHAOS_ENGINE_STARTUP_TIMEOUT: "900"
  artifacts:
    paths:
      - $ZAP_REPORT_FILE
  script:
    - ./ci/test/zap/zap_scan.sh